# ADR-018: Error Handling for WiFi Configuration

## Title
Error Handling & Recovery Strategy for WiFi Configuration

## Status
Proposed

## Context
Milestone M1 WiFi configuration involves multiple failure points that require clear error handling and user feedback (US01, US02, US03, US04):
- Invalid WiFi credentials entered by user
- Network unreachable or authentication failure
- Web frontend errors (PIN validation, form submission)
- NVS storage errors
- Timeout scenarios in connection attempts
- Loss of connectivity after successful connection

Requirements:
- Detect and classify errors
- Provide user feedback via LED patterns and web frontend
- Implement automatic retry with backoff
- Graceful fallback to AP mode
- Log errors for debugging (ADR-006)
- Prevent infinite retry loops

Challenges:
- Balancing automatic recovery vs. user intervention
- Distinguishing transient vs. permanent errors
- User communication without display (LED only)
- Maintaining system responsiveness during errors

## Alternatives

### Alternative 1: Minimal Error Handling with Manual Recovery
- Display generic error on web frontend
- LED shows error state (red fast blink)
- User must manually re-enter AP mode
- No automatic retry
- **Pros:**
  - Simple implementation
  - Predictable behavior
- **Cons:**
  - Poor user experience
  - No automatic recovery for transient errors
  - User must physically access device

### Alternative 2: Automatic Retry with Backoff and Fallback (Recommended)
- Classify errors: transient vs. permanent
- Automatic retry with exponential backoff for transient errors
- Return to AP mode after max retries or permanent error
- LED indicates error type (different patterns)
- Web frontend shows specific error messages
- Structured logging for diagnostics (ADR-006)
- **Pros:**
  - Handles transient errors automatically
  - Clear user feedback
  - Graceful degradation
  - Debuggable with logs
- **Cons:**
  - More complex implementation
  - Risk of infinite loops if not designed carefully

### Alternative 3: User-Configurable Retry Strategy
- Allow user to configure retry behavior via web frontend
- Options: no retry, fixed retry, exponential backoff
- **Pros:**
  - Maximum flexibility
  - User control
- **Cons:**
  - Overkill for typical use case
  - More configuration complexity
  - Confusing for non-technical users

## Decision
**Choose Alternative 2: Automatic Retry with Backoff and Fallback**

Rationale:
- Best user experience for typical scenarios
- Handles transient network issues automatically
- Clear error feedback for user intervention
- Aligns with robust error handling (ADR-006)
- Supports debugging with structured logs

Error Classification:

| Error Type            | Classification | Retry Strategy              | Fallback           |
|-----------------------|----------------|-----------------------------|---------------------|
| Invalid credentials   | Permanent      | No retry                    | Return to AP mode   |
| Network not found     | Transient*     | Retry 3x (10s, 20s, 40s)    | Return to AP mode   |
| Auth timeout          | Transient      | Retry 3x (10s, 20s, 40s)    | Return to AP mode   |
| DHCP failure          | Transient      | Retry 3x (10s, 20s, 40s)    | Return to AP mode   |
| Connection lost       | Transient      | Retry infinite** (10s, 30s) | Stay in normal mode |
| NVS write error       | Permanent      | No retry                    | Log error, continue |
| Web frontend error    | User error     | No retry                    | Show error message  |

*Network not found may be permanent (wrong SSID) or transient (AP offline). After max retries, treat as permanent.
**Infinite retry with backoff until user triggers AP mode or device reset.

LED Error Patterns (extends ADR-016):
- Red slow blink: Disconnected, retrying
- Red fast blink: Permanent error, return to AP mode
- Orange pulse: Transient error, retrying with backoff

Web Frontend Error Messages:
- "Invalid credentials. Please check SSID and password."
- "Network not found. Ensure WiFi is in range and try again."
- "Authentication failed. Verify password."
- "Connection timeout. Check network and try again."
- "Unexpected error. See logs for details."

Implementation approach:
1. Extend WiFi state machine (ADR-014) with error states
2. Implement error classification function based on ESP-IDF WiFi event reason codes
3. Add retry logic with exponential backoff timer
4. Store retry count in RAM (not NVS to avoid wear)
5. Define max retry limits in Kconfig (ADR-012)
6. Post error events to system event loop for LED updates
7. Return error codes from web API endpoints with descriptive messages
8. Log all errors with ESP_LOGE and context (ADR-006)
9. Add error counter in NVS for diagnostics (optional)

Retry Configuration (Kconfig):
- `CONFIG_WIFI_MAX_RETRY_TRANSIENT`: 3 (default)
- `CONFIG_WIFI_RETRY_BACKOFF_BASE_MS`: 10000 (default 10s)
- `CONFIG_WIFI_RETRY_MAX_BACKOFF_MS`: 300000 (default 5min)
- `CONFIG_WIFI_RECONNECT_INFINITE`: true (default, for connection loss)

## Consequences

**Positive:**
- Robust, user-friendly error handling
- Automatic recovery for common transient errors
- Clear user feedback via LED and web frontend
- Debuggable with structured logs
- Configurable retry behavior via Kconfig

**Negative:**
- More complex state machine logic
- Risk of edge cases if error classification is wrong
- Additional memory for retry state (~100 bytes)
- Requires thorough testing of error scenarios

**Follow-up Actions:**
1. Implement error classification based on ESP-IDF reason codes
2. Add retry state machine to WiFi manager (ADR-014)
3. Define LED error patterns in LED controller (ADR-016)
4. Implement web frontend error message handling
5. Add retry configuration to Kconfig (ADR-012)
6. Create unit tests for error scenarios (ADR-008)
7. Document error handling in user manual
8. Test error scenarios: wrong password, network down, DHCP failure, etc.

**Testing Requirements:**
- Unit tests for error classification logic
- Integration tests simulating network errors
- Field testing with real WiFi networks (strong/weak signal, congestion)
- Verify LED patterns match documented behavior
- Validate web frontend error messages

## References
- [ESP-IDF WiFi Driver - Event Handling](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html#wifi-event-handling)
- [ESP-IDF WiFi Reason Codes](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html#wifi-reason-code)
- [ADR-006: Error Handling & Diagnostics](ADR-006.md) - Logging strategy
- [ADR-012: Compile-Time Configuration](ADR-012.md) - Kconfig for retry limits
- [ADR-014: WiFi State Machine](ADR-014.md) - State transitions
- [ADR-016: LED Control Architecture](ADR-016.md) - LED error patterns
- [US01: WiFi Configuration via AP Mode](../stories/US01_wifi_ap_mode.md)
- [US02: Web Frontend for WiFi Setup](../stories/US02_web_frontend_wifi.md)
- [US03: Secure Storage of WiFi Credentials](../stories/US03_secure_wifi_storage.md)
- [US04: RGB LED State Indication](../stories/US04_rgb_led_state.md)
