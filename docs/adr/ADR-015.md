# ADR-015: Authentication & Device PIN Management

## Title
Authentication & Device PIN Management for Web Configuration

## Status
Proposed

## Context
Milestone M1 requires PIN-based authentication for the web configuration frontend (US02, US06) to prevent unauthorized WiFi credential changes. The device must have a unique, secure PIN that is:
- Generated or assigned during manufacturing/first boot
- Displayed to the legitimate device owner
- Validated during web frontend access
- Protected against brute-force attacks
- Compatible with Matter commissioning requirements (M2 forward compatibility)

Key requirements:
- PIN must be unique per device or easily resettable
- User must be able to view the PIN (via serial console, LED, or label)
- PIN-based session authentication for web access
- Brute-force protection (rate limiting, lockout)
- Integration with secure storage (ADR-005)
- Forward compatibility with Matter commissioning PIN (M2)

Challenges:
- Balancing security with usability (PIN complexity vs. ease of entry)
- Displaying PIN to user in M1 without LCD (serial console acceptable for development)
- Potential conflict between WiFi config PIN and Matter commissioning PIN
- Factory provisioning vs. first-boot generation

## Alternatives

### Alternative 1: Fixed 6-Digit PIN (Simple, Not Recommended)
- Use a hardcoded 6-digit PIN (e.g., 123456) for all devices
- Store in source code or Kconfig
- **Pros:**
  - Simple, no generation needed
  - Easy for users
- **Cons:**
  - Major security vulnerability
  - All devices have same PIN
  - Non-compliant with security standards
  - Unacceptable for production

### Alternative 2: Random PIN Generated at First Boot (Recommended for M1)
- Generate a random 8-digit PIN on first boot using ESP32 hardware RNG
- Store in encrypted NVS (ADR-005)
- Display via serial console and/or blink pattern on LED
- Allow reset via factory reset button sequence
- **Pros:**
  - Unique per device
  - Secure using hardware RNG
  - Simple implementation
  - Compatible with encrypted NVS
  - Can be reset by user
- **Cons:**
  - User must access serial console or learn blink pattern to read PIN (acceptable for M1)
  - Requires user documentation
  - PIN lost if NVS erased without backup

### Alternative 3: PIN Derived from Device MAC Address
- Generate PIN deterministically from device MAC address (e.g., last 8 digits of MAC)
- Display via serial console or label
- **Pros:**
  - Reproducible from hardware
  - Can be printed on device label during manufacturing
  - No storage needed
- **Cons:**
  - Less secure (predictable pattern)
  - Not truly random
  - Potential for collision or pattern attacks

### Alternative 4: Factory-Provisioned PIN (Production-Ready, Future)
- Generate unique PIN during manufacturing/flashing
- Store in factory NVS partition (write-protected)
- Print PIN on device label or include in packaging
- **Pros:**
  - Most secure and professional
  - User-friendly (PIN on label)
  - Write-protected factory partition
- **Cons:**
  - Requires manufacturing process integration
  - More complex for development/prototyping
  - Out of scope for M1

## Decision
**Choose Alternative 2 for M1: Random PIN Generated at First Boot**

Rationale for M1:
- Balances security and implementation complexity
- Uses hardware RNG for strong randomness
- Stores in encrypted NVS (ADR-005)
- Compatible with development workflow
- User can access PIN via serial console (acceptable for M1)
- Provides path to Alternative 4 for production (M3+)

**Forward Compatibility for M2 (Matter):**
- Matter commissioning uses separate setup PIN code
- WiFi config PIN (M1) and Matter setup PIN (M2) should be DIFFERENT for security
- Consider unifying to a single PIN in future milestones if UX demands it
- Document both PINs clearly to avoid user confusion

Implementation approach:
1. Generate 8-digit random PIN at first boot using `esp_random()`
2. Store PIN in encrypted NVS under namespace `config`, key `device_pin`
3. Display PIN on serial console at boot: `Device PIN: 12345678`
4. Optional: Implement LED blink pattern to display PIN (e.g., Morse code)
5. Validate PIN during web frontend `/api/auth` endpoint
6. Implement session management with secure random tokens (ADR-013)
7. Brute-force protection: max 5 attempts, 1-minute lockout after failure
8. Factory reset clears PIN, generates new one on next boot

## Consequences

**Positive:**
- Secure, unique PINs per device
- Compatible with encrypted NVS storage
- Resettable via factory reset
- Forward path to production provisioning
- Acceptable UX for development/prototyping

**Negative:**
- User must access serial console to read PIN in M1 (no physical display)
- PIN lost if NVS erased without documentation
- Additional user documentation required
- Potential confusion with Matter PIN in M2 (mitigated by clear docs)

**Follow-up Actions:**
1. Implement PIN generation at first boot
2. Store PIN securely in encrypted NVS (ADR-017 for key naming)
3. Display PIN on serial console with clear instructions
4. Implement brute-force protection in web authentication (ADR-013)
5. Document PIN access procedure for users
6. Design factory reset mechanism (button sequence)
7. Plan for unified PIN or separate PINs in M2 (revisit after Matter integration)

**Production Considerations (M3+):**
- Transition to Alternative 4 (factory provisioning)
- Implement write-protected factory NVS partition
- Print PIN on device label or QR code
- Consider LCD/e-paper display for PIN in hardware revision

## References
- [ESP-IDF Random Number Generation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/random.html)
- [ADR-005: Security Architecture](ADR-005.md) - Encrypted NVS
- [ADR-013: Web Server Architecture](ADR-013.md) - Session authentication
- [ADR-017: NVS Partition Layout](ADR-017.md) - Key naming for PIN storage
- [Matter Specification - Commissioning](https://csa-iot.org/developer-resource/specifications-download-request/) - Setup PIN code
- [US02: Web Frontend for WiFi Setup](../stories/US02_web_frontend_wifi.md)
- [US06: Authentication for Web Frontend](../stories/US06_web_authentication.md)
