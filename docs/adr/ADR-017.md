# ADR-017: NVS Partition Layout & Key Naming Convention

## Title
NVS Partition Layout & Key Naming Convention

## Status
Proposed

## Context
The device requires persistent storage for WiFi credentials (US03), device PIN (ADR-015), configuration parameters (US05), and future Matter/Thread data (M2). ESP-IDF provides Non-Volatile Storage (NVS) as a key-value store in flash memory. NVS supports:
- Namespaces for logical grouping
- Encrypted storage (ADR-005)
- Multiple partition types (factory, data)
- Atomic writes and wear leveling

Requirements:
- Store WiFi credentials securely (SSID, password)
- Store device configuration (PIN, last state)
- Future: Matter fabric credentials, Thread network data (M2)
- Support factory reset (clear runtime data, preserve factory settings)
- Efficient namespace and key organization
- Encryption for sensitive data (ADR-005)

Challenges:
- Namespace/key naming convention for maintainability
- Separating factory-provisioned vs. runtime data
- Migration strategy for future schema changes
- Encryption scope (all vs. selective)

## Alternatives

### Alternative 1: Single Namespace with Prefixed Keys
- Use one namespace (e.g., `storage`) with prefixed keys: `wifi_ssid`, `wifi_pass`, `config_pin`
- **Pros:**
  - Simple, all data in one place
  - Easy to backup/restore
- **Cons:**
  - No logical separation
  - Factory reset must selectively delete keys
  - Poor organization as project grows

### Alternative 2: Multiple Namespaces by Function (Recommended)
- Separate namespaces for different subsystems:
  - `config`: Device configuration (PIN, device name)
  - `wifi`: WiFi credentials and state
  - `matter`: Matter fabric data (M2)
  - `factory`: Factory-provisioned data (write-protected, future)
- Clear key naming within each namespace
- **Pros:**
  - Logical separation of concerns
  - Factory reset can erase namespaces selectively
  - Scales well for M2 and beyond
  - Clear ownership per component
- **Cons:**
  - Slightly more overhead (each namespace has metadata)
  - Need clear namespace assignment rules

### Alternative 3: Multiple NVS Partitions
- Use separate NVS partitions for different data types
- Factory partition (read-only after provisioning)
- Runtime partition (read-write)
- **Pros:**
  - Hardware-level separation
  - Factory data truly immutable
- **Cons:**
  - More complex partition table management
  - Overkill for M1
  - Better suited for production (M3+)

## Decision
**Choose Alternative 2: Multiple Namespaces by Function**

Rationale:
- Logical separation aligns with modular architecture (ADR-001)
- Scales for M2 Matter integration
- Supports selective factory reset
- Standard ESP-IDF practice
- Provides path to Alternative 3 for production

Namespace & Key Layout for M1:

| Namespace | Key           | Type   | Description                          | Encrypted |
|-----------|---------------|--------|--------------------------------------|-----------|
| `config`  | `device_pin`  | str    | 8-digit device PIN                   | Yes       |
| `config`  | `device_name` | str    | User-assigned device name (optional) | No        |
| `wifi`    | `ssid`        | str    | WiFi SSID                            | Yes       |
| `wifi`    | `password`    | str    | WiFi password                        | Yes       |
| `wifi`    | `last_state`  | u8     | Last successful connection state     | No        |
| `wifi`    | `retry_count` | u8     | Connection retry counter             | No        |

Future M2 Extensions:

| Namespace | Key             | Type   | Description                     | Encrypted |
|-----------|-----------------|--------|---------------------------------|-----------|
| `matter`  | `fabric_id`     | blob   | Matter fabric credentials       | Yes       |
| `matter`  | `setup_pin`     | str    | Matter commissioning setup PIN  | Yes       |
| `thread`  | `network_key`   | blob   | Thread network master key       | Yes       |
| `thread`  | `channel`       | u8     | Thread channel                  | No        |

Naming Conventions:
- Namespace: lowercase, single word or underscore-separated (e.g., `wifi`, `matter`)
- Keys: lowercase, underscore-separated (e.g., `device_pin`, `last_state`)
- Use descriptive names, avoid abbreviations unless standard (e.g., `ssid`)
- Document all keys in component header files

Implementation approach:
1. Define namespace constants in component headers (e.g., `wifi_manager.h`)
2. Use ESP-IDF NVS API for all read/write operations
3. Enable NVS encryption globally (ADR-005)
4. Implement helper functions for common operations (get/set credentials)
5. Add namespace documentation in code comments
6. Factory reset clears `wifi`, `matter`, `thread` namespaces, preserves `config`
7. Use Kconfig for default NVS partition size (ADR-012)

## Consequences

**Positive:**
- Clear, maintainable organization
- Logical separation by component
- Supports selective factory reset
- Scales for M2 and beyond
- Standard ESP-IDF conventions
- Easy to document and audit

**Negative:**
- Small metadata overhead per namespace (~50 bytes)
- Developers must follow naming conventions
- Requires documentation updates for new keys

**Follow-up Actions:**
1. Document namespace and key definitions in component headers
2. Implement NVS helper functions for each component
3. Enable NVS encryption in build configuration (ADR-005)
4. Create unit tests for NVS operations (ADR-008)
5. Document factory reset behavior (what gets cleared vs. preserved)
6. Plan migration strategy for future schema changes
7. Add NVS usage to troubleshooting documentation

**Migration Strategy:**
- Add version key in `config` namespace: `nvs_schema_version`
- Increment version when key layout changes
- Implement migration logic on boot if version mismatch detected
- Document migration in ADR updates

## References
- [ESP-IDF NVS Documentation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html)
- [ADR-001: System Architecture](ADR-001.md) - Modular design
- [ADR-005: Security Architecture](ADR-005.md) - NVS encryption
- [ADR-012: Compile-Time Configuration](ADR-012.md) - Kconfig for partition size
- [ADR-015: PIN Management](ADR-015.md) - Device PIN storage
- [US03: Secure Storage of WiFi Credentials](../stories/US03_secure_wifi_storage.md)
