# ADR-013: Web Server Architecture & HTTP Framework

## Title
Web Server Architecture & HTTP Framework for WiFi Configuration Portal

## Status
Proposed

## Context
Milestone M1 requires a web-based configuration portal accessible in AP mode for WiFi credential setup (US01, US02, US06). The device must serve a web frontend, handle HTTP requests, manage sessions for authentication, and serve both static assets and dynamic API endpoints. The ESP32-C6 has limited resources (512KB SRAM, 4MB Flash typical), so the web server must be lightweight yet functional.

Key requirements:
- Serve static HTML/CSS/JS files for the configuration frontend
- Handle REST API endpoints for credential submission and status
- Support authentication via device PIN
- Session management for authenticated users
- HTTPS/TLS support for secure credential transmission
- Minimal memory footprint
- Integration with FreeRTOS and event-driven architecture (ADR-001)

## Alternatives

### Alternative 1: ESP-IDF HTTP Server Component (Recommended)
- Use the built-in `esp_http_server` component from ESP-IDF
- Serves HTTP/HTTPS with URI handlers
- Supports WebSocket (optional for future use)
- Static file serving via custom handlers or embedded files
- Session management implemented manually using cookies or tokens
- **Pros:**
  - Native ESP-IDF component, well-tested and maintained
  - Lightweight and optimized for ESP32
  - Good documentation and examples
  - Supports both HTTP and HTTPS
  - No external dependencies
  - Easy integration with NVS and WiFi components
- **Cons:**
  - Manual implementation of session management
  - Static files must be embedded or served from flash partition
  - No built-in template engine (not needed for simple SPA)

### Alternative 2: Mongoose Embedded Web Server
- Use Mongoose OS embedded web server library
- Feature-rich with built-in session management
- Supports templating and advanced routing
- **Pros:**
  - More features out-of-the-box
  - Better session management
  - Template support
- **Cons:**
  - External dependency, increases code size
  - Less integrated with ESP-IDF ecosystem
  - Potentially higher memory footprint
  - More complex configuration

### Alternative 3: Custom Minimal HTTP Server
- Implement a minimal HTTP server from scratch using ESP-IDF sockets
- **Pros:**
  - Full control over implementation
  - Potentially smallest footprint
- **Cons:**
  - High development effort
  - Reinventing the wheel
  - More bugs and security risks
  - Poor maintainability

## Decision
**Choose Alternative 1: ESP-IDF HTTP Server Component**

Rationale:
- Native ESP-IDF component aligns with project architecture (ADR-001, ADR-008)
- Lightweight and proven on ESP32 platform
- Sufficient features for M1 requirements
- HTTPS support satisfies security requirements (ADR-005)
- Manual session management is acceptable for simple PIN-based auth
- Static files can be embedded using `EMBED_FILES` in CMakeLists.txt
- Well-documented with examples in ESP-IDF repository

Implementation approach:
1. Use `esp_http_server` for HTTP/HTTPS server
2. Embed static files (HTML/CSS/JS) in firmware binary using CMake `EMBED_FILES`
3. Implement session management using HTTP cookies with secure, random session tokens stored in RAM
4. Create REST API endpoints: `/api/auth`, `/api/wifi/status`, `/api/wifi/config`
5. Enable HTTPS with self-signed certificate for M1 (user accepts certificate in browser)
6. Run HTTP server in dedicated FreeRTOS task (as per ADR-001)

## Consequences

**Positive:**
- Standardized approach using ESP-IDF components
- Minimal external dependencies
- Good balance of features and resource usage
- Aligns with existing architectural decisions
- HTTPS support for secure credential transmission

**Negative:**
- Static files embedded in firmware increase binary size (~50-100KB for typical web UI)
- Self-signed HTTPS certificate requires user to accept browser warning
- Manual session management adds development effort (but keeps code simple)

**Follow-up Actions:**
1. Define REST API specification for WiFi configuration
2. Design web frontend (HTML/CSS/JS SPA)
3. Implement session token generation and validation
4. Configure HTTPS certificate generation in build system
5. Document web server configuration in Kconfig (ADR-012)

## References
- [ESP-IDF HTTP Server Documentation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_http_server.html)
- [ADR-001: System Architecture](ADR-001.md) - FreeRTOS task structure
- [ADR-005: Security Architecture](ADR-005.md) - HTTPS and credential protection
- [ADR-012: Compile-Time Configuration](ADR-012.md) - Kconfig for web server settings
- [US01: WiFi Configuration via AP Mode](../stories/US01_wifi_ap_mode.md)
- [US02: Web Frontend for WiFi Setup](../stories/US02_web_frontend_wifi.md)
- [US06: Authentication for Web Frontend](../stories/US06_web_authentication.md)
